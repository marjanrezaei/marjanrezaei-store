{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container content-space-1 content-space-lg-2">
  <div class="row">
    <!-- Cart Items Column -->
    <div class="col-lg-8 mb-7 mb-lg-0">
      <div class="d-flex justify-content-between align-items-end border-bottom pb-3 mb-7">
        <h1 class="h3 mb-0">سبد خرید</h1>
      </div>

      <ul class="list-group list-group-flush list-group-no-gutters mb-3" id="cart-items-list">
        <li class="list-group-item text-center p-2 text-sm">در حال بارگذاری...</li>
      </ul>

      <div class="d-sm-flex justify-content-end">
        <a class="link" href="{% url 'shop:product-list' %}">
          به خرید ادامه دهید <i class="bi-chevron-left small ms-1"></i>
        </a>
      </div>
    </div>
    <!-- End Cart Items Column -->

    <!-- Summary Column -->
    <div class="col-lg-4">
      <div class="ps-lg-4">
        <div class="card card-sm shadow-sm mb-4">
          <div class="card-body">
            <div class="border-bottom pb-4 mb-4">
              <h3 class="card-header-title">خلاصه هزینه</h3>
            </div>

            <dl class="row mb-4">
              <dt class="col-sm-6">مالیات</dt>
              <dd class="col-sm-12 text-sm-end mb-0">به همراه 9% در هنگام پرداخت</dd>

              <dt class="col-sm-6">جمع</dt>
              <dd class="col-sm-12 text-sm-end mb-0 formatted-price" id="total-payment-price">0 تومان</dd>
            </dl>

            <div class="d-grid">
              <a class="btn btn-primary btn-lg" href="{% url 'order:checkout' %}">ثبت سفارش</a>
            </div>
          </div>
        </div>

        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="svg-icon svg-icon-sm text-primary">
              <!-- SVG icon here -->
            </div>
          </div>
          <div class="flex-grow-1 ms-2">
            <span class="small me-1">نیاز به پشتیبانی دارید؟</span>
            <a class="link small" href="#">ارسال تیکت</a>
          </div>
        </div>
      </div>
    </div>
    <!-- End Summary Column -->
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

  // تبدیل قیمت به فرمت ایرانی
  function formatPrice(price) {
    return Number(price).toLocaleString('fa-IR') + ' تومان';
  }

  // رندر هر آیتم سبد خرید
  function renderCartItem(item) {
    return `
<li id="cart-item-${item.product_id}" class="list-group-item d-flex flex-column flex-sm-row justify-content-between align-items-center p-2 opacity-0 transition">
  <div class="d-flex align-items-center gap-2 w-100 w-sm-66">
    <img src="${item.product_image || '/static/img/default.jpg'}" class="rounded" style="width:40px;height:40px;object-fit:cover;" alt="${item.product_name}">
    <div>
      <h5 class="mb-0 small">${item.product_name}</h5>
      <p class="text-muted small mb-0">قیمت واحد: ${formatPrice(item.unit_price)}</p>
    </div>
  </div>
  <div class="d-flex align-items-center gap-1 mt-1 mt-sm-0 w-100 w-sm-33">
    <select class="form-select form-select-sm" onchange="changeProductQuantity(${item.product_id}, this.value)">
      ${[...Array(10).keys()].map(i => `
      <option value="${i + 1}" ${i + 1 === item.quantity ? 'selected' : ''}>${i + 1}</option>`
    ).join('')}
    </select>
    <span id="cart-item-total-${item.product_id}" class="fw-bold small ms-2">${formatPrice(item.total_price)}</span>
    <button onclick="removeProduct(${item.product_id})" class="btn btn-link btn-sm text-danger p-0 ms-2">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>
</li>`;
  }

  // بارگذاری سبد خرید
  async function fetchCartSummary() {
    const list = document.getElementById('cart-items-list');
    list.innerHTML = '<li class="text-center text-muted p-2 small">در حال بارگذاری...</li>';

    try {
      const response = await fetch('/api/cart/summary/');
      const data = await response.json();

      // بروزرسانی جمع کل
      document.getElementById('total-payment-price').textContent = formatPrice(data.total_payment_price || 0);

      if (!data.cart_items || data.cart_items.length === 0) {
        list.innerHTML = '<li class="text-center text-muted p-2 small">سبد خرید شما خالی است.</li>';
        return;
      }

      list.innerHTML = '';
      data.cart_items.forEach(item => {
        list.insertAdjacentHTML('beforeend', renderCartItem(item));
        const li = document.getElementById(`cart-item-${item.product_id}`);
        requestAnimationFrame(() => li.classList.remove('opacity-0'));
      });

    } catch (err) {
      console.error(err);
      list.innerHTML = '<li class="text-center text-danger p-2 small">خطا در بارگذاری سبد خرید.</li>';
    }
  }

  async function changeProductQuantity(productId, quantity) {
  quantity = parseInt(quantity, 10);  // تبدیل به عدد
  const itemEl = document.getElementById(`cart-item-${productId}`);
  if (itemEl) itemEl.classList.add('opacity-50');

  try {
    const updateUrl = "{% url 'cart_api:update-product-quantity-api' %}";

    const response = await fetch(updateUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({ product_id: productId, quantity: quantity })
    });

    if (!response.ok) {
      const errText = await response.text();
      console.error('خطا در تغییر تعداد محصول:', errText);
      alert('خطا در تغییر تعداد محصول.');
      return;
    }

    const data = await response.json();
    if (data.total_quantity !== undefined)
        document.getElementById('total-cart-item-count').textContent = data.total_quantity;

    if (data.item_total !== undefined)
      document.getElementById(`cart-item-total-${productId}`).textContent = formatPrice(data.item_total);

    if (data.cart_total !== undefined)
      document.getElementById('total-payment-price').textContent = formatPrice(data.cart_total);

  } catch (err) {
    console.error(err);
    alert('خطا در تغییر تعداد محصول.');
  } finally {
    if (itemEl) itemEl.classList.remove('opacity-50');
  }
}

  async function removeProduct(productId) {
      const itemEl = document.getElementById(`cart-item-${productId}`);
      if (itemEl) {
          itemEl.classList.add('opacity-0', 'translate-x-full', 'transition', 'duration-500');

          setTimeout(async () => {
              try {
                  const formData = new FormData();
                  formData.append("product_id", productId);

                  const response = await fetch('/api/cart/remove-product/', {
                      method: 'POST',
                      headers: { 'X-CSRFToken': csrftoken },
                      body: formData
                  });

                  if (!response.ok) {
                      console.error("خطا در حذف محصول:", await response.text());
                      return;
                  }

                  const data = await response.json();

                  // حذف آیتم از DOM
                  itemEl.remove();

                  // بروزرسانی شمارنده سبد خرید (jQuery style)
                  if (data.total_quantity !== undefined) {
                      $("#total-cart-item-count").text(data.total_quantity);
                  }

              } catch (err) {
                  console.error(err);
                  alert('خطا در حذف محصول.');
              }
          }, 500);
      }
  }

  document.addEventListener('DOMContentLoaded', fetchCartSummary);
</script>
{% endblock %}