{% extends 'base.html' %}
{% load static i18n %}

{% block content %}
<!-- Breadcrumb -->
<div class="bg-light">
  <div class="container py-4">
    <div class="row">
      <div class="col-sm">
        <h4 class="mb-0">{% trans "Product Grid" %}</h4>
      </div>
      <div class="col-sm-auto">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item ps-2"><a href="/index.html">{% trans "Shop" %}</a></li>
            <li class="breadcrumb-item"><a href="/products-grid.html">{% trans "Products" %}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{% trans "Grid" %}</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="container content-space-t-2 content-space-b-2">
  <div class="row">
    <div class="col-lg-3">
      <!-- Sidebar Filters -->
      <form action=".">
        <div class="border-bottom pb-4 mb-4">
          <h5>{% trans "Search Product" %}</h5>
          <input class="form-control" placeholder="{% trans "Enter search term" %}" type="text" name="q">
        </div>

        <div class="border-bottom pb-4 mb-4">
          <h5>{% trans "Price" %}</h5>
          <input class="form-control mb-2" type="number" name="min_price" placeholder="{% trans "Min Price" %}">
          <input class="form-control" type="number" name="max_price" placeholder="{% trans "Max Price" %}">
        </div>

        <div class="border-bottom pb-4 mb-4">
          <h5>{% trans "Category" %}</h5>
          <select class="form-select form-select-sm" name="category_id">
            <option value="" selected>{% trans "Select Category" %}</option>
            {% for category in categories %}
              <option value="{{category.id}}">{{category.title}}</option>
            {% endfor %}
          </select>
        </div>

        <button type="submit" class="btn btn-white btn-transition">{% trans "Apply Filter" %}</button>
      </form>
    </div>

    <div class="col-lg-9">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h6 class="mb-0">{{total_items}} {% trans "Products" %}</h6>
        <div class="d-flex align-items-center gap-2">
          <select class="form-select form-select-sm" id="order-by-filter">
            <option value="" selected>{% trans "Sort By" %}</option>
            <option value="-created_at">{% trans "Newest" %}</option>
            <option value="created_at">{% trans "Oldest" %}</option>
            <option value="-price">{% trans "Highest Price" %}</option>
            <option value="price">{% trans "Lowest Price" %}</option>
          </select>
          <select class="form-select form-select-sm" id="page-size-filter">
            <option value="" selected>{% trans "Items Per Page" %}</option>
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary btn-sm active" id="grid-view-btn">
              <i class="bi bi-grid-fill"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="list-view-btn">
              <i class="bi bi-list"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Grid View -->
      <div id="grid-view" class="row row-cols-sm-2 row-cols-md-3 mb-10">
        {% for object in object_list %}
        <div class="col mb-4">
          <div class="card card-bordered shadow-none text-center h-100">
            <div class="card-pinned">
              {% if object.image_url %}
                <img class="card-img" src="{{ object.image_url }}" alt="{{ object.title }}">
              {% elif object.image %}
                <img class="card-img" src="{{ object.image.url }}" alt="{{ object.title }}">
              {% else %}
                <img src="{% static 'img/default.jpg' %}" alt="No image">
              {% endif %}

              {% if request.user.is_authenticated %}
              <div class="card-pinned-top-end">
                <button type="button"
                        class="btn btn-outline-secondary btn-xs btn-icon rounded-circle {% if object.id in wishlist_items %} active {% endif %}"
                        onclick="addToWishlist(this,`{{object.id}}`)">
                  <i class="bi-heart"></i>
                </button>
              </div>
              {% endif %}
            </div>

            <div class="card-body">
              <div class="mb-2">
                {% for category in object.category.all %}
                  <a class="link-sm link-secondary" href="#">{{ category.title }}</a>{% if not forloop.last %}, {% endif %}
                {% endfor %}
              </div>

              <h4 class="card-title">
                <a class="text-dark" href="{% url 'shop:product-detail' slug=object.slug %}">{{ object.title }}</a>
              </h4>

              {% if object.is_discounted %}
                <h3 class="text-dark">{{ object.get_price }}</h3>
                <span class="text-muted text-decoration-line-through">{{ object.price }}</span>
              {% else %}
                <h3 class="text-dark">{{ object.price }}</h3>
              {% endif %}
            </div>

            <div class="card-footer pt-0">
              <div class="d-flex justify-content-center align-items-center mb-2">
                {% for i in "12345" %}
                  {% if forloop.counter <= object.avg_rate %} 
                    <i class="bi bi-star-fill text-warning"></i>
                  {% else %}
                    <i class="bi bi-star text-warning"></i>
                  {% endif %}
                {% endfor %}
                <span class="ms-2 small">{{ object.avg_rate }}/5</span>
              </div>

              <button class="btn btn-outline-primary btn-sm btn-transition rounded-pill btn-add-to-cart"
                      data-product-id="{{ object.id }}">{% trans "Add to Cart" %}</button>
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-center py-5">{% trans "No products available" %}</p>
        {% endfor %}
      </div>

      <!-- List View -->
      <div id="list-view" class="d-none flex-column gap-4">
        {% for object in object_list %}
        <div class="card card-bordered shadow-none">
          <div class="row g-0 align-items-center">
            <div class="col-md-3">
              {% if object.image_url %}
                <img class="img-fluid rounded-start" src="{{ object.image_url }}" alt="{{ object.title }}">
              {% elif object.image %}
                <img class="img-fluid rounded-start" src="{{ object.image.url }}" alt="{{ object.title }}">
              {% else %}
                <img class="img-fluid rounded-start" src="{% static 'img/default.jpg' %}" alt="No image">
              {% endif %}
            </div>
            <div class="col-md-9">
              <div class="card-body">
                <h5 class="card-title">
                  <a class="text-dark" href="{% url 'shop:product-detail' slug=object.slug %}">{{ object.title }}</a>
                </h5>

                <p>
                  {% for category in object.category.all %}
                    <span class="badge bg-light text-dark me-1">{{ category.title }}</span>
                  {% endfor %}
                </p>

                {% if object.is_discounted %}
                  <p>
                    <strong class="text-danger">{{ object.get_price }}</strong>
                    <span class="text-muted text-decoration-line-through">{{ object.price }}</span>
                  </p>
                {% else %}
                  <p><strong>{{ object.price }}</strong></p>
                {% endif %}

                <div class="d-flex align-items-center mb-2">
                  {% for i in "12345" %}
                    {% if forloop.counter <= object.avg_rate %} 
                      <i class="bi bi-star-fill text-warning"></i>
                    {% else %}
                      <i class="bi bi-star text-warning"></i>
                    {% endif %}
                  {% endfor %}
                  <span class="ms-2 small">{{ object.avg_rate }}/5</span>
                </div>

                <div class="d-flex align-items-center gap-2 mt-3">
                  <button class="btn btn-outline-primary btn-sm btn-transition rounded-pill btn-add-to-cart"
                          data-product-id="{{ object.id }}">{% trans "Add to Cart" %}</button>

                  {% if request.user.is_authenticated %}
                  <button type="button" class="btn btn-outline-secondary btn-xs btn-icon
                    rounded-circle {% if object.id in wishlist_items %} active {% endif %}" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="{% trans "Add to Wishlist" %}" onclick="addToWishlist(this,`{{object.id}}`)">
                    <i class="bi-heart"></i>
                  </button>
                  {% endif %}
                </div>

              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-center py-5">{% trans "No products available" %}</p>
        {% endfor %}
      </div>

    </div>
  </div>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
    <li class="page-item">
      <button class="page-link" onclick="changePage('{{ page_obj.previous_page_number }}')" aria-label="Previous">
        <i class="bi-chevron-double-right small"></i>
      </button>
    </li>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
    {% if num == page_obj.number %}
    <li class="page-item active">
      <button class="page-link" onclick="changePage('{{num}}')">{{ num }}</button>
    </li>
    {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %} <li class="page-item">
      <button class="page-link" onclick="changePage('{{num}}')">{{ num }}</button>
      </li>
      {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
      <li class="page-item">
        <button class="page-link" onclick="changePage('{{ page_obj.next_page_number }}')" aria-label="Next">
          <i class="bi-chevron-double-left small"></i>
        </button>
      </li>
      {% endif %}
  </ul>
</nav>
{% endif %}

<!-- End Pagination -->

</div>
<!-- End Col -->
</div>
<!-- End Row -->
</div>
<!-- End Card Grid -->

<!-- Subscribe -->
  {% include 'subscribe.html' %}
<!-- End Subscribe -->

<!-- Clients -->
<div class="container content-space-2">
  <div class="row">
    <div class="col text-center py-3">
      <img class="avatar avatar-lg avatar-4x3" src="{% static 'svg/brands/hollister-dark.svg' %}" alt="Logo">
    </div>
    <!-- End Col -->

    <div class="col text-center py-3">
      <img class="avatar avatar-lg avatar-4x3" src="{% static 'svg/brands/levis-dark.svg' %}" alt="Logo">
    </div>
    <!-- End Col -->

    <div class="col text-center py-3">
      <img class="avatar avatar-lg avatar-4x3" src="{% static 'svg/brands/new-balance-dark.svg' %}" alt="Logo">
    </div>
    <!-- End Col -->

    <div class="col text-center py-3">
      <img class="avatar avatar-lg avatar-4x3" src="{% static 'svg/brands/puma-dark.svg' %}" alt="Logo">
    </div>
    <!-- End Col -->

    <div class="col text-center py-3">
      <img class="avatar avatar-lg avatar-4x3" src="{% static 'svg/brands/nike-dark.svg' %}" alt="Logo">
    </div>
    <!-- End Col -->

    <div class="col text-center py-3">
      <img class="avatar avatar-lg avatar-4x3" src="{% static 'svg/brands/tnf-dark.svg' %}" alt="Logo">
    </div>
    <!-- End Col -->
  </div>
  <!-- End Row -->
</div>
<!-- End Clients -->
{% endblock content %}

{% block extra_js %}

<script>
  $(document).ready(function () {
    let current_url_params = new URLSearchParams(window.location.search)
    $("#page-size-filter").val(current_url_params.get('page_size') || "")
    $("#search-query-filter").val(current_url_params.get('q') || "")
    $("#min-price-filter").val(current_url_params.get('min_price') || "")
    $("#max-price-filter").val(current_url_params.get('max_price') || "")
    $("#order-by-filter").val(current_url_params.get('order_by') || "")
    $("#category-id-filter").val(current_url_params.get('category_id') || "")


  });

  $('#page-size-filter').change(function () {
    let current_url_params = new URLSearchParams(window.location.search)
    var selectedValue = $(this).val();
    current_url_params.set('page_size', selectedValue)
    current_url_params.set('page', 1);
    let new_url = window.location.pathname + "?" + current_url_params.toString()
    window.location.href = new_url
  });
  $('#order-by-filter').change(function () {
    let current_url_params = new URLSearchParams(window.location.search)
    var selectedValue = $(this).val();
    current_url_params.set('order_by', selectedValue)
    current_url_params.set('page', 1);
    let new_url = window.location.pathname + "?" + current_url_params.toString()
    window.location.href = new_url
  });
</script>

<script>
  // سوییچ بین گرید و لیست
  const gridBtn = document.getElementById('grid-view-btn');
  const listBtn = document.getElementById('list-view-btn');
  const gridView = document.getElementById('grid-view');
  const listView = document.getElementById('list-view');

  gridBtn.addEventListener('click', () => {
    gridView.classList.remove('d-none');
    listView.classList.add('d-none');
    gridBtn.classList.add('active');
    listBtn.classList.remove('active');
  });

  listBtn.addEventListener('click', () => {
    listView.classList.remove('d-none');
    gridView.classList.add('d-none');
    listBtn.classList.add('active');
    gridBtn.classList.remove('active');
  });

  // تابع تغییر صفحه برای pagination
  function changePage(pageNumber) {
    let current_url_params = new URLSearchParams(window.location.search);
    current_url_params.set('page', pageNumber);
    let new_url = window.location.pathname + "?" + current_url_params.toString();
    window.location.href = new_url;
  }
</script>
<script>
  $(document).on('click', '.btn-add-to-cart', function () {
    const productId = $(this).data('product-id');

    $.ajax({
      url: '{% url "cart_api:add-to-cart-api" 0 %}'.replace('0', productId),
      type: 'POST',
      data: {
        product_id: productId,
        quantity: 1
      },
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      success: function (response) {
        if (response.total_quantity !== undefined) {
          $("#total-cart-item-count").text(response.total_quantity);
        }
      },
      error: function (xhr, status, error) {
        alert("خطا در افزودن کالا به سبد خرید.");
        console.error(error);
      }
    });
  });
</script>

{% endblock extra_js %}