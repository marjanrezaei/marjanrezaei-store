{% extends 'base.html' %}
{% load static i18n %}

{% block content %}
<!-- Content -->
<div class="container content-space-1 content-space-lg-2">
  <div class="row">
    <div class="col-lg-8 mb-7 mb-lg-0">
      <h4 class="mb-3">{% trans "Select Address" %}</h4>

      <!-- Form -->
      <form action="." method="post" id="checkout-form">
        {% csrf_token %}

        <hr class="my-4">

        <div class="d-grid gap-2">

          <!-- Check -->
          {% for address in addresses %}
          <div class="form-check">
            <input type="radio" class="form-check-input" name="address_id" id="address-{{ address.id }}" value="{{address.id}}" required>
            <label class="form-check-label" for="address-{{ address.id }}">
              {{address.state}}, {{address.city}}, {{address.address}}, {{address.zip_code}}
            </label>
          </div>
          {% endfor %}
          <!-- End Check -->

          <div>
            <a class="" href="{% url 'dashboard:customer:address-list' %}">{% trans "Manage Addresses" %}</a>
          </div>
        </div>

        <hr class="my-4">

        <div class="row align-items-center">
          <div class="col-sm text-center text-sm-start">
            <a class="link" href="{% url 'cart:cart-summary' %}">
              {% trans "Back to Cart" %} <i class="bi-chevron-left small ms-1"></i>
            </a>
          </div>
        </div>
        <!-- End Row -->
      </form>
      <!-- End Form -->
    </div>
    <!-- End Col -->

    <div class="col-lg-4">
      <div class="ps-lg-4">
        <!-- Card -->
        <div class="card card-sm shadow-sm mb-4">
          <div class="card-body">
            <div class="border-bottom pb-4 mb-4">
              <h3 class="card-header-title">{% trans "Order Summary" %}</h3>
            </div>

            <div class="input-group border-bottom pb-4 mb-3">
              <input type="text" class="form-control text-center" name="coupon" placeholder="{% trans 'Coupon Code' %}"
                     aria-label="{% trans 'Coupon Code' %}" form="checkout-form" id="coupon-input">
              <button class="btn btn-primary" type="button" onclick="validateCoupon(event)">{% trans "Check" %}</button>
            </div>

            <div class="border-bottom pb-4 mb-4">
              <div class="d-grid gap-3">
                <dl class="row">
                  <dt class="col-sm-6">{% trans "Shipping Cost" %}</dt>
                  <dd class="col-sm-12 text-sm-end mb-0">{% trans "For Tehran and suburbs: 35,000 Toman" %}</dd>
                  <dd class="col-sm-12 text-sm-end mb-0">{% trans "For other cities: 50,000 Toman" %}</dd>
                </dl>
              </div>
            </div>

            <div class="d-grid gap-3 mb-4">
              <dl class="row">
                <dt class="col-sm-6">{% trans "Total" %}</dt>
                <dd class="col-sm-6 text-sm-end mb-0" id="total-price">{{ total_price }}</dd>
              </dl>
              <dl class="row">
                <dt class="col-sm-6">{% trans "Discounted Price" %}</dt>
                <dd class="col-sm-6 text-sm-end mb-0" id="discounted-price">{{ discounted_price }}</dd>
              </dl>
              <dl class="row">
                <dt class="col-sm-6">{% trans "Tax (9%)" %}</dt>
                <dd class="col-sm-6 text-sm-end mb-0" id="total-tax">{{ total_tax }}</dd>
              </dl>
              <dl class="row">
                <dt class="col-sm-6 fw-bold">{% trans "Final Payable Amount" %}</dt>
                <dd class="col-sm-6 text-sm-end fw-bold" id="final-price-with-tax">{{ final_price_with_tax }}</dd>
              </dl>
            </div>

            <div class="d-grid">
              <button class="btn btn-primary btn-lg" type="submit" form="checkout-form">{% trans "Place Order" %}</button>
            </div>
          </div>
        </div>
        <!-- End Card -->

        <!-- Support Media -->
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <div class="svg-icon svg-icon-sm text-primary">
              <!-- SVG icon -->
            </div>
          </div>
          <div class="flex-grow-1 ms-2">
            <span class="small me-1">{% trans "Need support?" %}</span>
            <a class="link small" href="#">{% trans "Submit Ticket" %}</a>
          </div>
        </div>
        <!-- End Media -->
      </div>
    </div>
    <!-- End Col -->
  </div>
  <!-- End Row -->
</div>
<!-- End Content -->
{% endblock %}

{% block extra_js %}
<script>
function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function validateCoupon(event) {
  const couponInput = $('#coupon-input');
  const code = couponInput.val().trim();
  const button = $(event.currentTarget);

  if (!code) {
    Toastify({
      text: "{% trans 'Please enter coupon code.' %}",
      className: "error",
      style: { background: "red" },
      gravity: "center",
      position: "center",
    }).showToast();
    return;
  }

  button.prop('disabled', true).text("{% trans 'Checking...' %}");

  $.ajax({
    url: "{% url 'order_api:validate-coupon-api' %}",
    method: 'POST',
    data: {
      code: code,
      csrfmiddlewaretoken: getCSRFToken()
    },
    success: function (response) {
      Toastify({
        text: response.message || "{% trans 'Coupon applied.' %}",
        className: "info",
        style: { background: "blue" },
        gravity: "center",
        position: "center",
      }).showToast();

      if (response.total_price !== undefined) {
        $('#total-price').text(response.total_price);
      }
      if (response.discounted_price !== undefined) {
        $('#discounted-price').text(response.discounted_price);
      }
      if (response.total_tax !== undefined) {
        $('#total-tax').text(response.total_tax);
      }
      if (response.final_price_with_tax !== undefined) {
        $('#final-price-with-tax').text(response.final_price_with_tax);
      }
    },
    error: function (xhr) {
      let message = "{% trans 'An error occurred.' %}";
      if (xhr.responseJSON && xhr.responseJSON.message) {
        message = xhr.responseJSON.message;
      }
      Toastify({
        text: message,
        className: "error",
        style: { background: "red" },
        gravity: "center",
        position: "center",
      }).showToast();
    },
    complete: function () {
      button.prop('disabled', false).text("{% trans 'Check' %}");
    }
  });
}
</script>
{% endblock %}
