{% extends 'base.html' %}
{% load static i18n %}

{% block content %}
<div class="container content-space-2 content-space-lg-3">
  <div class="w-md-75 w-lg-50 text-center mx-md-auto">
    <div class="mb-5">
      <img class="img-fluid" src="{% static 'svg/illustrations/oc-hi-five.svg' %}" alt="{% trans "Image Description" %}" style="width: 15rem;">
    </div>

    <div class="mb-5">
      <h1 class="h2" id="order_status_heading">{% trans "Checking your order..." %}</h1>
      <p id="order_status_message"></p>
    </div>

    <a class="btn btn-primary btn-transition rounded-pill px-6" href="{% url 'shop:product-list' %}">{% trans "Continue Shopping" %}</a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const orderId = "{{ order_id }}";
    if (!orderId) return;

    const apiUrl = `/api/order/${orderId}/status/`;

    // توکن امن
    const authToken = "{% if user.is_authenticated and user.auth_token %}{{ user.auth_token.key }}{% else %}{% endif %}";
    const headers = {};
    if (authToken) {
        headers['Authorization'] = `Token ${authToken}`;
    }

    fetch(apiUrl, { headers })
    .then(res => res.json())
    .then(data => {
        const heading = document.getElementById('order_status_heading');
        const message = document.getElementById('order_status_message');

        if (data.status === 'completed') {
            heading.textContent = '{% trans "Your order is completed!" %}';
            message.innerHTML = `
                {% trans "Order Number" %}: <strong>#${data.id}</strong><br>
                {% trans "Total" %}: <strong>${data.total_price} Toman</strong>
            `;
        } else {
            heading.textContent = '{% trans "Your order has an issue!" %}';
            message.textContent = '{% trans "Please try again or contact support." %}';
        }
    })
    .catch(err => {
        const heading = document.getElementById('order_status_heading');
        heading.textContent = '{% trans "Error loading order information" %}';
        console.error(err);
    });
});
</script>
{% endblock %}
