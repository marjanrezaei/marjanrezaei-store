{% extends 'base.html' %}

{% block title %} Reset Password {% endblock title %}

{% block content %}
<div class="container content-space-3 content-space-t-lg-4 content-space-b-lg-3">
  <div class="flex-grow-1 mx-auto" style="max-width: 28rem;">
    <!-- Heading -->
    <div class="text-center mb-5 mb-md-7">
      <h1 class="h2">فرم بازیابی رمز عبور</h1>
      <p>لطفا رمز عبور جدید خود را وارد نمایید</p>
    </div>
    <!-- End Heading -->

    <form id="reset-password-form">
        {% csrf_token %}
        <div class="mb-3">
            <label class="form-label" for="new_password1">رمز عبور جدید:</label>
            <input type="password" class="form-control form-control-lg text-center" name="new_password1" required>
        </div>
        <div class="mb-3">
            <label class="form-label" for="new_password2">تکرار رمز عبور:</label>
            <input type="password" class="form-control form-control-lg text-center" name="new_password2" required>
        </div>
        <div class="d-grid mb-3">
            <button type="submit" class="btn btn-primary btn-lg">بازیابی رمز عبور</button>
        </div>
        <div id="reset-message" class="text-center text-danger"></div>
    </form>
  </div>
</div>

<script>
document.getElementById('reset-password-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const password1 = this.new_password1.value;
    const password2 = this.new_password2.value;
    const resetMessage = document.getElementById('reset-message');

    if(password1 !== password2) {
        resetMessage.innerText = "رمز عبور و تکرار آن یکسان نیست!";
        return;
    }

    try {
        const response = await fetch("/api/accounts/reset-password/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                new_password1: password1,
                new_password2: password2,
                // در صورت نیاز می‌توان توکن یا uid و token را هم اضافه کرد
            })
        });

        const data = await response.json();

        if(response.ok) {
            resetMessage.classList.remove('text-danger');
            resetMessage.classList.add('text-success');
            resetMessage.innerText = "رمز عبور با موفقیت تغییر کرد. اکنون می‌توانید وارد شوید.";
        } else {
            resetMessage.classList.remove('text-success');
            resetMessage.classList.add('text-danger');
            resetMessage.innerText = data.detail || "خطا در بازیابی رمز عبور";
        }
    } catch(err) {
        console.error(err);
        resetMessage.innerText = "خطا در ارتباط با سرور";
    }
});
</script>
{% endblock content %}
