{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<div class="container mt-5" style="max-width: 28rem;">
  <h2 class="mb-4 text-center">{% trans "Reset Password" %}</h2>
  <p class="text-center">{% trans "Enter your new password below." %}</p>

  <form id="reset-confirm-form">
    {% csrf_token %}
    <div class="mb-3">
      <label for="new_password" class="form-label">{% trans "New Password" %}</label>
      <input type="password" id="new_password" class="form-control" required>
    </div>
    <div class="mb-3">
      <label for="confirm_password" class="form-label">{% trans "Confirm Password" %}</label>
      <input type="password" id="confirm_password" class="form-control" required>
    </div>
    <div class="d-grid">
      <button type="submit" class="btn btn-primary">{% trans "Reset Password" %}</button>
    </div>
    <div id="reset-confirm-message" class="text-center mt-2"></div>
  </form>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.getElementById('reset-confirm-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const new_password = document.getElementById('new_password').value;
  const confirm_password = document.getElementById('confirm_password').value;
  const message = document.getElementById('reset-confirm-message');
  message.innerText = '';
  message.className = "text-center mt-2";

  const texts = {
    mismatch: "{% trans 'Passwords do not match.' %}",
    missingToken: "{% trans 'Invalid or missing token.' %}",
    serverError: "{% trans 'Server error. Try again later.' %}"
  };

  if (new_password !== confirm_password) {
    message.classList.add("text-danger");
    message.innerText = texts.mismatch;
    return;
  }

  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");

  if (!token) {
    message.classList.add("text-danger");
    message.innerText = texts.missingToken;
    return;
  }

  try {
    const response = await fetch(`/api/accounts/reset-password-confirm/?token=${token}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ new_password, confirm_password })
    });

    const data = await response.json();

    if (response.ok) {
      message.classList.remove("text-danger");
      message.classList.add("text-success");
      message.innerText = data.message;
      this.reset();
    } else {
      message.classList.remove("text-success");
      message.classList.add("text-danger");
      message.innerText = data.error || texts.serverError;
    }
  } catch(err) {
    console.error(err);
    message.classList.remove("text-success");
    message.classList.add("text-danger");
    message.innerText = texts.serverError;
  }
});
</script>
{% endblock extra_js %}