{% extends 'base.html' %}
{% load static i18n %}

{% block content %}
<div class="container content-space-t-3 content-space-b-lg-2" style="max-width: 28rem;">
  <h2 class="mb-4 text-center">{% trans "Sign Up" %}</h2>
  <form id="register-form" novalidate>
    {% csrf_token %}

    <div class="mb-3">
      <label for="email">{% trans "Email" %}</label>
      <input type="email" id="email" class="form-control" placeholder="email@site.com" required>
    </div>

    <div class="mb-3">
      <label for="password">{% trans "Password" %}</label>
      <input type="password" id="password" class="form-control" placeholder="********" required>
    </div>

    <div class="mb-3">
      <label for="password1">{% trans "Confirm Password" %}</label>
      <input type="password" id="password1" class="form-control" placeholder="********" required>
    </div>

    <div class="mb-3">
      <label for="first_name">{% trans "First Name" %}</label>
      <input type="text" id="first_name" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="last_name">{% trans "Last Name" %}</label>
      <input type="text" id="last_name" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="phone_number">{% trans "Phone Number" %}</label>
      <input type="text" id="phone_number" class="form-control" placeholder="{% trans 'e.g. +971501234567' %}" required>
    </div>

    <div class="d-grid">
      <button type="submit" class="btn btn-primary">{% trans "Sign Up" %}</button>
    </div>

    <div id="register-message" class="text-danger mt-2"></div>

    <div class="mt-3 text-center">
      <a href="{% url 'accounts:login' %}">{% trans "Login to your account" %}</a> |
      <a href="{% url 'accounts:reset-password' %}">{% trans "Forgot Password?" %}</a>
    </div>
  </form>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.getElementById('register-form').addEventListener('submit', async e => {
  e.preventDefault();

  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const password1 = document.getElementById('password1').value;
  const first_name = document.getElementById('first_name').value.trim();
  const last_name = document.getElementById('last_name').value.trim();
  const phone_number = document.getElementById('phone_number').value.trim();
  const msg = document.getElementById('register-message');

  const texts = {
    mismatch: "{% trans 'Passwords do not match.' %}",
    success: "{% trans 'Registration successful! Please check your email to activate your account.' %}",
    serverError: "{% trans 'Server connection error.' %}"
  };

  if (password !== password1) {
    msg.innerText = texts.mismatch;
    return;
  }

  try {
    const response = await fetch('/api/accounts/register/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ email, password, password1, first_name, last_name, phone_number })
    });

    const data = await response.json();

    if (response.ok) {
      msg.classList.remove('text-danger');
      msg.classList.add('text-success');
      msg.innerText = texts.success;
      document.getElementById('register-form').reset();
    } else {
      msg.classList.remove('text-success');
      msg.classList.add('text-danger');
      msg.innerText = JSON.stringify(data);
    }
  } catch (err) {
    msg.classList.remove('text-success');
    msg.classList.add('text-danger');
    msg.innerText = texts.serverError;
  }
});
</script>
{% endblock extra_js %}