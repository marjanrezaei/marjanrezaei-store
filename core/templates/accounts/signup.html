{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5" style="max-width: 28rem;">
  <h2 class="mb-4 text-center">ثبت نام</h2>
  <form id="register-form" novalidate>
    {% csrf_token %}

    <div class="mb-3">
      <label for="email">ایمیل</label>
      <input type="email" id="email" class="form-control" placeholder="email@site.com" required>
    </div>

    <div class="mb-3">
      <label for="password">کلمه عبور</label>
      <input type="password" id="password" class="form-control" placeholder="********" required>
    </div>

    <div class="mb-3">
      <label for="password1">تکرار کلمه عبور</label>
      <input type="password" id="password1" class="form-control" placeholder="********" required>
    </div>

    <div class="mb-3">
      <label for="first_name">نام</label>
      <input type="text" id="first_name" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="last_name">نام خانوادگی</label>
      <input type="text" id="last_name" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="phone_number">شماره تلفن</label>
      <input type="text" id="phone_number" class="form-control" placeholder="09123456789" required>
    </div>

    <div class="d-grid">
      <button type="submit" class="btn btn-primary">ثبت نام</button>
    </div>

    <div id="register-message" class="text-danger mt-2"></div>

    <div class="mt-3 text-center">
      <a href="{% url 'accounts:login' %}">ورود به حساب کاربری</a> |
      <a href="{% url 'accounts:reset-password' %}">فراموشی کلمه عبور</a>
    </div>
  </form>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.getElementById('register-form').addEventListener('submit', async e => {
  e.preventDefault();

  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const password1 = document.getElementById('password1').value;
  const first_name = document.getElementById('first_name').value.trim();
  const last_name = document.getElementById('last_name').value.trim();
  const phone_number = document.getElementById('phone_number').value.trim();

  const msg = document.getElementById('register-message');

  // Password match validation
  if (password !== password1) {
    msg.innerText = "کلمه عبور و تکرار آن یکسان نیست";
    return;
  }

  try {
    const response = await fetch('/api/accounts/register/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ email, password, password1, first_name, last_name, phone_number })
    });

    const data = await response.json();

    if (response.ok) {
      msg.classList.remove('text-danger');
      msg.classList.add('text-success');
      msg.innerText = "ثبت نام موفق! لطفا ایمیل خود را برای فعال سازی بررسی کنید.";
      document.getElementById('register-form').reset();
    } else {
      msg.classList.remove('text-success');
      msg.classList.add('text-danger');
      msg.innerText = JSON.stringify(data);
    }
  } catch (err) {
    msg.classList.remove('text-success');
    msg.classList.add('text-danger');
    msg.innerText = "خطا در ارتباط با سرور";
  }
});
</script>
{% endblock extra_js %}
