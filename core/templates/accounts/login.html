{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-5" style="max-width: 28rem;">
  <h2 class="mb-4 text-center">ÙˆØ±ÙˆØ¯</h2>
  <form id="login-form" method="post" novalidate>
    {% csrf_token %}
    <div class="mb-3">
      <label for="email">Ø§ÛŒÙ…ÛŒÙ„</label>
      <input type="email" id="email" class="form-control" placeholder="email@site.com" required>
    </div>

    <div class="mb-3">
      <label for="password">Ú©Ù„Ù…Ù‡ Ø¹Ø¨ÙˆØ±</label>
      <input type="password" id="password" class="form-control" placeholder="********" required>
    </div>

    <div class="d-grid">
      <button type="submit" class="btn btn-primary">ÙˆØ±ÙˆØ¯</button>
    </div>
    <div id="login-message" class="text-danger mt-2"></div>
  </form>

  <!-- ğŸ”— Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ -->
  <div class="mt-3 text-center">
    <a href="{% url 'accounts:signup' %}">Ø«Ø¨Øªâ€Œ Ù†Ø§Ù…</a> |
    <a href="{% url 'accounts:reset-password' %}">ÙØ±Ø§Ù…ÙˆØ´ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</a>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'js/auth.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('login-form');
    const message = document.getElementById('login-message');

    form.addEventListener('submit', async e => {
      e.preventDefault();
      message.innerText = '';

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password) {
        message.innerText = 'Ù„Ø·ÙØ§ Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
        return;
      }

      try {
        const response = await fetch('/api/accounts/login/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok) {
          localStorage.setItem('access', data.access);
          localStorage.setItem('refresh', data.refresh);
          localStorage.setItem('user', JSON.stringify(data.user));

          window.location.href = '/';
        } else {
          message.innerText = data.detail || 'Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯';
        }
      } catch (err) {
        console.error(err);
        message.innerText = 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±';
      }
    });
  });
</script>
{% endblock extra_js %}