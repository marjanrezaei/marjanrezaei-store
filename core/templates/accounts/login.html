{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-5" style="max-width: 28rem;">
  <h2 class="mb-4 text-center">ورود</h2>
  <form id="login-form" method="post" novalidate>
    {% csrf_token %}
    <div class="mb-3">
      <label for="email">ایمیل</label>
      <input type="email" id="email" class="form-control" placeholder="email@site.com" required>
    </div>

    <div class="mb-3">
      <label for="password">کلمه عبور</label>
      <input type="password" id="password" class="form-control" placeholder="********" required>
    </div>

    <div class="d-grid">
      <button type="submit" class="btn btn-primary">ورود</button>
    </div>
    <div id="login-message" class="text-danger mt-2"></div>
  </form>
</div>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'js/auth.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('login-form');
  const message = document.getElementById('login-message');

  form.addEventListener('submit', async e => {
    e.preventDefault();
    message.innerText = '';

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    if (!email || !password) {
      message.innerText = 'لطفا ایمیل و رمز عبور را وارد کنید';
      return;
    }

    try {
      const response = await fetch('/api/accounts/login/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const data = await response.json();

      if (response.ok) {
      localStorage.setItem('access', data.access);
      localStorage.setItem('refresh', data.refresh);

      localStorage.setItem('user', JSON.stringify(data.user));

      window.location.href = '/';
      } 
      else {
          message.innerText = data.detail || 'خطا در ورود';
      }
    } catch (err) {
      console.error(err);
      message.innerText = 'خطا در ارتباط با سرور';
    }
  });
});
</script>
{% endblock extra_js %}