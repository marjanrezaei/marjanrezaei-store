{% extends 'base.html' %}
{% load static i18n %}

{% block content %}
<div class="container content-space-t-5 content-space-b-lg-2" style="max-width: 28rem;">
  <h2 class="mb-4 text-center">{% trans "Login" %}</h2>
  <form id="login-form" method="post" novalidate>
    {% csrf_token %}
    <div class="mb-3">
      <label for="email">{% trans "Email" %}</label>
      <input type="email" id="email" class="form-control" placeholder="email@site.com" required>
    </div>

    <div class="mb-3">
      <label for="password">{% trans "Password" %}</label>
      <input type="password" id="password" class="form-control" placeholder="********" required>
    </div>

    <div class="d-grid">
      <button type="submit" class="btn btn-primary">{% trans "Login" %}</button>
    </div>
    <div id="login-message" class="text-danger mt-2"></div>
  </form>

  <!-- Links -->
  <div class="mt-3 text-center">
    <a href="{% url 'accounts:signup' %}">{% trans "Sign Up" %}</a> |
    <a href="{% url 'accounts:reset-password' %}">{% trans "Forgot Password?" %}</a>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'js/auth.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('login-form');
    const message = document.getElementById('login-message');

    const texts = {
      required: "{% trans 'Please enter your email and password.' %}",
      loginError: "{% trans 'Login failed.' %}",
      serverError: "{% trans 'Server connection error.' %}"
    };

    form.addEventListener('submit', async e => {
      e.preventDefault();
      message.innerText = '';

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password) {
        message.innerText = texts.required;
        return;
      }

      try {
        const response = await fetch('/api/accounts/login/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok) {
          localStorage.setItem('access', data.access);
          localStorage.setItem('refresh', data.refresh);
          localStorage.setItem('user', JSON.stringify(data.user));
          window.location.href = '/';
        } else {
          message.innerText = data.detail || texts.loginError;
        }
      } catch (err) {
        console.error(err);
        message.innerText = texts.serverError;
      }
    });
  });
</script>
{% endblock extra_js %}