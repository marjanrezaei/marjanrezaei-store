{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<div class="container content-space-t-5 content-space-b-lg-2" style="max-width: 28rem;">
  <h2 class="mb-4 text-center">{% trans "Forgot Password" %}</h2>
  <p class="text-center">{% trans "Enter your email to receive a password reset link." %}</p>

  <form id="reset-request-form">
    {% csrf_token %}
    <div class="mb-3">
      <label for="email" class="form-label">{% trans "Email" %}</label>
      <input type="email" id="email" class="form-control" placeholder="email@site.com" required>
    </div>
    <div class="d-grid">
      <button type="submit" class="btn btn-primary">{% trans "Send Reset Link" %}</button>
    </div>
    <div id="reset-request-message" class="text-center mt-2"></div>
  </form>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.getElementById('reset-request-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const email = document.getElementById('email').value.trim();
  const message = document.getElementById('reset-request-message');
  message.innerText = '';
  message.className = "text-center mt-2";

  const texts = {
    required: "{% trans 'Please enter your email.' %}",
    success: "{% trans 'A password reset link has been sent to your email.' %}",
    notFound: "{% trans 'Email not found.' %}",
    serverError: "{% trans 'Server connection error. Please try again.' %}"
  };

  if (!email) {
    message.classList.add("text-danger");
    message.innerText = texts.required;
    return;
  }

  try {
    const response = await fetch('/api/accounts/reset-password/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });

    const data = await response.json();

    if (response.ok) {
      message.classList.remove("text-danger");
      message.classList.add("text-success");
      message.innerText = texts.success;

      if (data.token) {
        localStorage.setItem('password_reset_jwt', data.token);
      }
    } else {
      message.classList.remove("text-success");
      message.classList.add("text-danger");
      message.innerText = data.error || texts.notFound;
    }
  } catch (err) {
    console.error(err);
    message.classList.remove("text-success");
    message.classList.add("text-danger");
    message.innerText = texts.serverError;
  }
});
</script>
{% endblock extra_js %}