{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container content-space-3 content-space-t-lg-4 content-space-b-lg-3">
  <div class="mx-auto" style="max-width: 28rem;">

    <!-- Heading -->
    <div class="text-center mb-5 mb-md-7">
      <h1 class="h2">پروفایل شما</h1>
      <p class="text-muted">اطلاعات حساب کاربری شما</p>
    </div>

    <!-- Profile Card -->
    <div class="card text-center p-4">
      <img id="profile-image" src="{% static 'images/default.jpg' %}" alt="Profile" class="rounded-circle mb-3" width="120">
      <h3 id="profile-name">کاربر جدید</h3>
      <p id="profile-email" class="text-muted"></p>
      <p id="profile-phone" class="text-muted"></p>
      <button class="btn btn-danger mt-3" id="logout-btn">خروج</button>
    </div>

  </div>
</div>
{% endblock content %}

<script src="{% static 'js/auth.js' %}"></script>
<script>
  async function loadProfile() {
    const token = Auth.getAccessToken();
    if (!token) {
      window.location.href = "{% url 'accounts_api:login-api' %}";
      return;
    }

    try {
      const response = await fetch('/accounts/profile/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      });

      if (response.ok) {
        const data = await response.json();
        document.getElementById('profile-name').innerText = data.fullname || 'کاربر جدید';
        document.getElementById('profile-email').innerText = data.email || '';
        document.getElementById('profile-phone').innerText = data.phone_number || '';
        document.getElementById('profile-image').src = data.image || "{% static 'img/default.jpg' %}";
      } else {
        Auth.clear();
        window.location.href = "{% url 'accounts_api:login-api' %}";
      }
    } catch (err) {
      console.error(err);
      Auth.clear();
      window.location.href = "{% url 'accounts_api:login-api' %}";
    }
  }

  document.getElementById('logout-btn').addEventListener('click', () => {
    Auth.clear();
    window.location.href = "{% url 'accounts_api:login-api' %}";
  });

  loadProfile();
</script>
